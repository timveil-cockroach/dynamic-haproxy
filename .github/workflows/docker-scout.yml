name: Docker Scout Analysis

on:
  schedule:
    # Run weekly on Monday at 9am UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  scout-analysis:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Project
        uses: actions/checkout@v5

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Docker Scout Compare with Previous Version
        uses: docker/scout-action@v1
        with:
          command: compare
          image: timveil/dynamic-haproxy:latest
          to: timveil/dynamic-haproxy:latest
          exit-code: false
          only-severities: critical,high,medium

      - name: Docker Scout Recommendations
        uses: docker/scout-action@v1
        with:
          command: recommendations
          image: timveil/dynamic-haproxy:latest
          
      - name: Docker Scout SBOM
        uses: docker/scout-action@v1
        with:
          command: sbom
          image: timveil/dynamic-haproxy:latest
          format: spdx
          output: sbom.json
          
      - name: Upload SBOM as Artifact
        uses: actions/upload-artifact@v5
        with:
          name: sbom
          path: sbom.json
          retention-days: 30